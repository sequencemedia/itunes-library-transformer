"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.transformAlbumsToM3U8=void 0;var _fs=require("fs");var _path=require("path");var _fsExtra=require("fs-extra");var _querystring=require("querystring");var _itunesLibraryStream=require("@sequencemedia/itunes-library-stream");var _common=require("./common");const transformAlbumsToM3U8=(destination,ext)=>({[_itunesLibraryStream.TRACKS]:tracks})=>{if(tracks){const values=Array.from(tracks.values());const albums=values.filter(_common.filterAlbums);albums.reduce((accumulator,current)=>{if(current.has('Album Artist')){const s=(0,_common.normalise)(current.get('Album Artist'));return accumulator.includes(s)?accumulator:accumulator.concat(s);}return accumulator;},[]).sort().forEach(artist=>{const byAlbumArtist=albums.filter(track=>track.has('Album Artist')&&(0,_common.normalise)(track.get('Album Artist'))===artist);byAlbumArtist.reduce((accumulator,current)=>{const s=(0,_common.normalise)(current.get('Album'));return accumulator.includes(s)?accumulator:accumulator.concat(s);},[]).sort().forEach(album=>{const filePath=(0,_path.resolve)(`${destination}/Tracks/${(0,_common.normaliseForFilePath)(artist)}/${(0,_common.normaliseForFilePath)(album)}.${ext}`);const byAlbum=byAlbumArtist.filter(track=>(0,_common.normalise)(track.get('Album'))===album);const fileData=byAlbum.reduce((accumulator,current)=>{const n=Number(current.get('Disc Number'));return accumulator.includes(n)?accumulator:accumulator.concat(n);},[]).sort(_common.sortAsNumber).map(discNumber=>{const byDiscNumber=byAlbum.filter(track=>Number(track.get('Disc Number'))===discNumber);const fileData=byDiscNumber.reduce((accumulator,current)=>{const n=Number(current.get('Track Number'));return accumulator.includes(n)?accumulator:accumulator.concat(n);},[]).sort(_common.sortAsNumber).map(trackNumber=>{const byTrackNumber=byDiscNumber.filter(track=>Number(track.get('Track Number'))===trackNumber);const fileData=byTrackNumber.map(track=>{const time=parseInt(track.get('Total Time')/1000,10)||-1;const name=track.get('Name');const artist=track.get('Artist');const file=(0,_querystring.unescape)((track.get('Location')||'').replace('file://',''));return`#EXTINF:${time},${name} - ${artist}\n${file}`;});return fileData.join('\n');});return fileData.join('\n');});(0,_fsExtra.ensureFile)(filePath,e=>{if(e){console.error(e);return;}(0,_fs.writeFile)(filePath,`#EXTM3U\n${fileData.join('\n')}\n`,'utf8',e=>{if(e){console.error(e);}});});});});albums.reduce((accumulator,current)=>{if(current.has('Artist')&&(!current.has('Album Artist')||!current.get('Album Artist'))){const s=(0,_common.normalise)(current.get('Artist'));return accumulator.includes(s)?accumulator:accumulator.concat(s);}return accumulator;},[]).sort().forEach(artist=>{const byAlbumArtist=albums.filter(track=>track.has('Artist')&&(!track.has('Album Artist')||!track.get('Album Artist'))&&(0,_common.normalise)(track.get('Artist'))===artist);byAlbumArtist.reduce((accumulator,current)=>{const s=(0,_common.normalise)(current.get('Album'));return accumulator.includes(s)?accumulator:accumulator.concat(s);},[]).sort().forEach(album=>{const filePath=(0,_path.resolve)(`${destination}/Tracks/${(0,_common.normaliseForFilePath)(artist)}/${(0,_common.normaliseForFilePath)(album)}.${ext}`);const byAlbum=byAlbumArtist.filter(track=>(0,_common.normalise)(track.get('Album'))===album);const fileData=byAlbum.reduce((accumulator,current)=>{const n=Number(current.get('Disc Number'));return accumulator.includes(n)?accumulator:accumulator.concat(n);},[]).sort(_common.sortAsNumber).map(discNumber=>{const byDiscNumber=byAlbum.filter(track=>Number(track.get('Disc Number'))===discNumber);const fileData=byDiscNumber.reduce((accumulator,current)=>{const n=Number(current.get('Track Number'));return accumulator.includes(n)?accumulator:accumulator.concat(n);},[]).sort(_common.sortAsNumber).map(trackNumber=>{const byTrackNumber=byDiscNumber.filter(track=>Number(track.get('Track Number'))===trackNumber);const fileData=byTrackNumber.map(track=>{const time=parseInt(track.get('Total Time')/1000,10)||-1;const name=track.get('Name');const artist=track.get('Artist');const file=(0,_querystring.unescape)((track.get('Location')||'').replace('file://',''));return`#EXTINF:${time},${name} - ${artist}\n${file}`;});return fileData.join('\n');});return fileData.join('\n');});(0,_fsExtra.ensureFile)(filePath,e=>{if(e){console.error(e);return;}(0,_fs.writeFile)(filePath,`#EXTM3U\n${fileData.join('\n')}\n`,'utf8',e=>{if(e){console.error(e);}});});});});}};exports.transformAlbumsToM3U8=transformAlbumsToM3U8;